<html>
<head>

<style>

body
{
  margin: 18px;
}

.sys {
  background-color: #86BAEC;
  border-style: solid;
  border-width: 1px;
  border-color: #ACA892;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
  color: white
}

.sys_error {
  background-color: #eeaaaa;
  color: #404040;
  border-style: solid;
  border-width: 1px;
  border-color: #ACA892;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.sysmsg {
  padding: 8px 8px 8px 8px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.msgbox {
  background-color: white;
  color: #404040;
  border-style: solid;
  border-width: 1px;
  border-color: #A9A9A9;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.msgbox_sending {
  background-color: #eeeeee;
  color: #404040;
  border-style: solid;
  border-width: 1px;
  border-color: #A9A9A9;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.msgbox_failed {
  background-color: #eeaaaa;
  color: #404040;
  border-style: solid;
  border-width: 1px;
  border-color: #A9A9A9;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.msgbox_deferred {
  background-color: #EDF2FF;
  color: #404040;
  border-style: solid;
  border-width: 1px;
  border-color: #A9A9A9;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.msgbox_old {
  background-color: white;
  color: #898989;
  border-style: solid;
  border-width: 1px;
  border-color: #A9A9A9;
  padding: 2px 2px 2px 2px;
  margin-bottom: 10px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  -webkit-border-radius: 5px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.message {
  padding: 0px 8px 8px 8px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
  margin-left: 30px;
}

.header {
  padding: 0px 8px 8px 0px;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}

.recipient {
  color: #436294;
  font-weight: bold;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  text-align: left;
  padding-top: 4px;
  padding-left: 8px;
}

.recipient_self {
  color: #629443;
  font-weight: bold;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  text-align: left;
  padding-top: 4px;
  padding-left: 8px;
}

.body {
  width: 100%;
}

.photobox {
  margin: 5px;
  width: 32px;
  float: left;
  -webkit-border-radius: 3px;
}

.timestamp {
  color: #436294;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  float: right; /*width: 150px;*/
  text-align: right;
}

.timestamp_hidden {
  color: #436294;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  float: right; /*width: 150px;*/
  text-align: right;
  display: none;
}

.state {
  color: #436294;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  float: right; /*width: 150px;*/
  text-align: right;
}

.systimestamp {
  color: #436294;
  padding-top: 8px;
  padding-right: 8px;
  font-family: Lucida Grande, Helvetica, Arial;
  font-size: 11px;
  float: right; /*width: 150px;*/
  text-align: right;
  word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;
}


</style>

<script type="text/javascript">

var lastSender;
var lastTimestamp;

function clear()
{
  var placeholder;
  placeholder = document.getElementById("placeholder"); 
  placeholder.innerHTML = "";
}

function formatTimestamp(timestamp)
{
    return timestamp;
    
    var ts = timestamp.split(" ");
    var date = ts[0];
    var time = ts[1];
    
    var ts = time.split(":");
    
    return ts[0]+":"+ts[1]+":"+ts[2];
}

function addChatMessage(msgid, sender, iconpath, text, timestamp, state)
{
  var placeholder;
  var content;
  var idstr;
  var message_class;
  
  timestamp = formatTimestamp(timestamp);
  
  placeholder = document.getElementById("placeholder");

  status = ''

  if (msgid  != null)
  {
    box_class = "msgbox_sending";
  } else {
    box_class = "msgbox";
    status = timestamp;
  }

  if (state == "deferred") {
      box_class = "msgbox_deferred";
      status = "Deferred for later ";
  } else if (state == "failed") {
      box_class = "msgbox_failed"
      status = "Failed ";
  }
  
  if (content != null)
      content.id = "";

  if (msgid  != null)
  {
    placeholder.innerHTML += 
    "<div>"+
    "<img class='photobox' src='file:"+iconpath+"'/>"+
    "<div class='"+box_class+"' id='"+msgid+"'>"+
         "<div class='header'>"+
             "<div class='recipient_self'>"+sender+"</div>"+
             "<div class='timestamp_hidden' id='t"+msgid+"'>" +timestamp+"</div>"+
             "<div class='state' id='s"+msgid+"'>Sending...</div>"+
         "</div>"+
         "<div class='message'>"+
            "<span class='body'>"+text+"</span>"+
        "</div>"+
    "</div>"+
    "</div>";
  } else {
    placeholder.innerHTML += 
    "<div>"+
    "<img class='photobox' src='file:"+iconpath+"'/>"+
    "<div class='"+box_class+"'>"+
         "<div class='header'>"+
             "<div class='recipient'>"+sender+"</div>"+
             "<div class='timestamp'>"+status+"</div>"+
         "</div>"+
         "<div class='message'>"+
            "<span class='body'>"+text+"</span>"+
        "</div>"+
    "</div>"+
    "</div>";  
  }

  lastSender = sender;
  lastTimestamp = timestamp;
  
  scrollToBottom();
}


function fixupMessageId(oldid, msgid)
{
  var msg = document.getElementById(oldid);
  if (msg != null)
    msg.id = msgid;
    
  msg = document.getElementById('t'+oldid);
  if (msg != null)
    msg.id = 't'+msgid;
    
  msg = document.getElementById('s'+oldid);
  if (msg != null)
    msg.id = 's'+msgid;
}


function markDelivered(msgid)
{
  var msg = document.getElementById(msgid);
  if (msg != null)
    msg.className = "msgbox";

  msg = document.getElementById('t'+msgid)
  if (msg != null)
    msg.style.display = "block";
  msg = document.getElementById('s'+msgid)
  if (msg != null)
    msg.style.display = "none";
}

function markDeferred(msgid)
{
  var msg = document.getElementById(msgid);
  if (msg != null)
    msg.className = "msgbox_deferred";

  msg = document.getElementById('t'+msgid)
  if (msg != null)
    msg.style.display = "none";
  msg = document.getElementById('s'+msgid)
  if (msg != null)
    msg.style.display = "block";
    msg.innerHTML = "Deferred for later ";
}

function markFailed(msgid)
{
  var msg = document.getElementById(msgid);
  if (msg != null)
    msg.className = "msgbox_failed";
    
  msg = document.getElementById('t'+msgid)
  if (msg != null)
      msg.style.display = "none";

  msg = document.getElementById('s'+msgid)
  if (msg != null)
  {
    msg.style.display = "block";
    msg.innerHTML = "Failed ";
  }
}


function addOldChatMessage(isme, msgid, sender, iconpath, text, timestamp, state)
{
  var placeholder;
  var content;

  timestamp = formatTimestamp(timestamp);
  
  placeholder = document.getElementById("placeholder");
  
  if (content != null)
      content.id = "";

  status = '';

  if (state == "deferred") {
      _class = "msgbox_deferred";
      status = "Deferred for later ";
  } else if (state == "failed") {
      _class = "msgbox_failed"
      status = "Failed ";
  } else {
      _class = "msgbox_old"
  }
    
  placeholder.innerHTML += 
    "<div>"+
    "<img class='photobox' src='file:"+iconpath+"'/>"+
    "<div class='"+ _class + "'>"+
         "<div class='header'>"+
             "<div class='"+(isme ? "recipient_self" : "recipient")+"'>"+sender+"</div>"+
             "<div class='timestamp'>" + timestamp +"</div>"+
         "</div>"+
         "<div class='message'>"+
            "<span class='body'>"+text+"</span>"+
        "</div>"+
    "</div>"+
    "</div>";

  lastSender = ">"+sender;
  lastTimestamp = timestamp;
  
  scrollToBottom();
}


function addSysMessage(text, timestamp, is_error)
{
  var placeholder;
  var content;
  
  timestamp = formatTimestamp(timestamp);
  
  placeholder = document.getElementById("placeholder");
  content = document.getElementById("content");
  
  if (content != null)
      content.id = "";

  placeholder.innerHTML += 
    "<div class=sys>"+
            "<div class='systimestamp'>"+timestamp+"</div>"+
            "<div class='sysmsg'>"+
                text+
            "</div>"+
    "</div>";

  lastSender = "";
  
  scrollToBottom();
  
  return 0;
}

function addSysErrorMessage(text, timestamp)
{
  var placeholder;
  var content;
  
  timestamp = formatTimestamp(timestamp);
  
  placeholder = document.getElementById("placeholder");
  content = document.getElementById("content");
  
  if (content != null)
      content.id = "";

  placeholder.innerHTML += 
    "<div class='sys_error'>"+
            "<div class='systimestamp'>"+timestamp+"</div>"+
            "<div class='sysmsg'>"+
                text+
            "</div>"+
    "</div>";

  lastSender = "";
  
  scrollToBottom();
  
  return 0;
}


function scrollToBottom()
{
    window.scroll(0, document.body.scrollHeight);
}

</script>
</head>
<body>

<div id="placeholder"></div>

</body>
</html>
